<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Videollamada - Serpleno</title>

<link rel="stylesheet" href="assets/css/styles.css">

<style>
  .meet-container {
    max-width: 860px;
    margin: 0 auto;
    padding: 18px;
    text-align: center;
  }
  .jitsi-box {
    width: 100%;
    height: 480px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px #0003;
  }
</style>
</head>

<body>

<main class="meet-container">
  <h2 style="margin-bottom:10px;">Videollamada</h2>

  <div id="msg" class="alert danger" style="display:none;margin-bottom:15px;"></div>

  <div id="meetBox" style="display:none;">
    <h3 style="margin-bottom:8px;" id="meetTitle"></h3>
    <div id="jitsiContainer" class="jitsi-box"></div>
  </div>

  <p style="margin-top:18px;">
    <a class="btn outline" href="notifications.html">Ir a notificaciones</a>
  </p>
</main>


<script>
/* =======================================================
   Cargar la reunión desde el backend (/meeting)
======================================================= */
async function loadMeeting() {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login";

  const res = await fetch("/meeting", {
    headers: { "Authorization": "Bearer " + token }
  });

  const j = await res.json();

  const msgBox = document.getElementById("msg");
  const meetBox = document.getElementById("meetBox");

  // Si hubo un error
  if (!j.ok) {
    msgBox.style.display = "block";
    msgBox.textContent = j.error || "No tienes reuniones programadas.";

    if (j.redirect) {
      setTimeout(() => location.href = j.redirect, 1500);
    }
    return;
  }

  const m = j.meeting;

  // Mostrar título
  document.getElementById("meetTitle").textContent =
    `Reunión con ${m.professional} (${m.speciality})`;

  meetBox.style.display = "block";

  // Si la BD ya tiene URL → úsala
  if (m.meeting_url) {
    initJitsi(m.meeting_url);
  } else {
    // Fallback: generar sala por email
    const userEmail = j.user?.email || "user";
    const room = "SerplenoMeeting_" + userEmail.replace(/[^a-zA-Z0-9]/g, "");
    const url = `https://meet.jit.si/${room}`;
    initJitsi(url);
  }
}

loadMeeting();


/* =======================================================
   Inicializar Jitsi
======================================================= */
function initJitsi(meetingUrl) {
  const container = document.getElementById("jitsiContainer");

  // Extraer solo el nombre de la sala de la URL
  const room = meetingUrl.split("/").pop();

  const script = document.createElement("script");
  script.src = "https://meet.jit.si/external_api.js";

  script.onload = () => {
    new JitsiMeetExternalAPI("meet.jit.si", {
      roomName: room,
      parentNode: container,
      width: "100%",
      height: "100%",
      interfaceConfigOverwrite: {
        SHOW_JITSI_WATERMARK: false
      }
    });
  };

  document.body.appendChild(script);
}
</script>

</body>
</html>

